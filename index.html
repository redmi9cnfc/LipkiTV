<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LipkiTV</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

<style>
:root{
  --bg:#0b0f1a;
  --card:#121826;
  --accent:#6366f1;
  --text:#e5e7eb;
  --muted:#9ca3af;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui, Arial;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* ===== Layout ===== */

.app{
  display:flex;
  flex-direction:column;
  height:100vh;
  padding:12px;
  gap:12px;
}

/* ===== Groups ===== */

.groups{
  display:flex;
  gap:8px;
  overflow-x:auto;
  scrollbar-width:none;
}

.groups::-webkit-scrollbar{
  display:none;
}

.group{
  flex:0 0 auto;
  padding:8px 14px;
  border-radius:20px;
  background:var(--card);
  cursor:pointer;
  white-space:nowrap;
  font-size:14px;
  transition:.2s;
}

.group.active{
  background:var(--accent);
}

/* ===== Player ===== */

.video-wrap{
  background:black;
  border-radius:14px;
  overflow:hidden;
  aspect-ratio:16/9;
}

video{
  width:100%;
  height:100%;
}

/* ===== Info ===== */

#now{
  font-size:14px;
  color:var(--muted);
}

/* ===== Channels ===== */

.channels-holder{
  flex:1;
  overflow-y:auto;
}

.channels{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:10px;
}

.channel{
  background:var(--card);
  padding:10px;
  border-radius:12px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  transition:.2s;
}

.channel:hover{
  background:var(--accent);
}

.channel img{
  width:40px;
  height:40px;
  object-fit:contain;
}

/* ===== TV mode ===== */

@media(min-width:1600px){
  .channel{
    padding:18px;
    font-size:18px;
  }
}
</style>
</head>

<body>

<div class="app">

  <div class="groups" id="groups"></div>

  <div class="video-wrap">
    <video id="video" controls playsinline></video>
  </div>

  <div id="now">—</div>

  <input id="search" placeholder="Поиск..." style="padding:8px;border-radius:8px;border:none;background:#1e293b;color:white">

  <div class="channels-holder">
    <div id="channels" class="channels"></div>
  </div>

</div>

<script>
const BUILTIN_URL =
"https://raw.githubusercontent.com/mopidplus-max/LiTV/refs/heads/main/liTV.m3u";

const video = document.getElementById("video");
const groupsEl = document.getElementById("groups");
const channelsEl = document.getElementById("channels");
const searchInput = document.getElementById("search");
const nowEl = document.getElementById("now");

let channels = [];
let currentGroup = null;
let hls = null;

/* ===== LOAD ===== */

async function loadPlaylist(){
  try{
    const r = await fetch(BUILTIN_URL);
    const text = await r.text();
    parseM3U(text);
  }catch(e){
    nowEl.textContent = "Ошибка загрузки плейлиста";
  }
}

/* ===== PARSER ===== */

function parseM3U(text){
  channels = [];
  let lines = text.split("\n");
  let metaLine = null;

  for(let line of lines){
    line = line.trim();

    if(line.startsWith("#EXTINF")){
      metaLine = line;
    }
    else if(line && !line.startsWith("#")){
      let name = line;
      let group = "Other";
      let logo = "";

      if(metaLine){

        const parts = metaLine.split(",");
        if(parts.length > 1)
          name = parts[parts.length - 1].trim();

        const groupMatch = metaLine.match(/group-title="([^"]+)"/i);
        if(groupMatch) group = groupMatch[1];

        const logoMatch = metaLine.match(/tvg-logo="([^"]+)"/i);
        if(logoMatch) logo = logoMatch[1];
      }

      channels.push({
        name: name || "Unknown",
        url: line,
        group,
        logo
      });

      metaLine = null;
    }
  }

  renderGroups();
}

/* ===== GROUPS ===== */

function renderGroups(){
  const groups = [...new Set(channels.map(c=>c.group))];

  groupsEl.innerHTML="";
  groups.forEach(g=>{
    const div=document.createElement("div");
    div.className="group";
    div.textContent=g;
    div.onclick=()=>selectGroup(g);
    groupsEl.appendChild(div);
  });

  selectGroup(groups[0]);
}

function selectGroup(g){
  currentGroup=g;
  [...groupsEl.children].forEach(el=>
    el.classList.toggle("active",el.textContent===g)
  );
  renderChannels();
}

/* ===== CHANNELS ===== */

function renderChannels(){
  const q = searchInput.value.toLowerCase();
  channelsEl.innerHTML="";

  channels
    .filter(c=>c.group===currentGroup &&
      c.name.toLowerCase().includes(q))
    .forEach(c=>{
      const div=document.createElement("div");
      div.className="channel";

      div.innerHTML = `
        ${c.logo ? `<img src="${c.logo}">` : ""}
        <div>${c.name}</div>
      `;

      div.onclick=()=>play(c);

      channelsEl.appendChild(div);
    });
}

searchInput.oninput=renderChannels;

/* ===== PLAYER ===== */

function play(ch){
  if(hls) hls.destroy();
  nowEl.textContent = ch.name;

  if(Hls.isSupported() && ch.url.includes(".m3u8")){
    hls = new Hls({
      maxBufferLength: 20,
      maxMaxBufferLength: 30,
      enableWorker: true
    });
    hls.loadSource(ch.url);
    hls.attachMedia(video);
  }else{
    video.src = ch.url;
  }
}

loadPlaylist();
</script>

</body>
</html>
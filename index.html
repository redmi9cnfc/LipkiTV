<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LipkiTV</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <style>
        *{box-sizing:border-box}
        body{
            margin:0;
            background:#0f172a;
            color:#f1f5f9;
            font-family:system-ui,-apple-system,sans-serif;
            height:100vh;
            overflow:hidden;
        }
        .app{
            display:flex;
            flex-direction:column;
            height:100vh;
            padding:8px;
            gap:8px;
        }
        .header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:4px 8px;
        }
        .logo{
            font-size:24px;
            font-weight:bold;
            background:linear-gradient(135deg,#6366f1,#7c3aed);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .video-wrap{
            background:#000;
            border-radius:16px;
            overflow:hidden;
            aspect-ratio:16/9;
            box-shadow:0 10px 25px rgba(0,0,0,0.5);
            flex-shrink:0;
        }
        video{
            width:100%;
            height:100%;
            outline:none;
        }
        #now{
            text-align:center;
            color:#94a3b8;
            font-size:13px;
            padding:4px;
            background:rgba(0,0,0,0.2);
            border-radius:8px;
            margin:0;
        }
        #search{
            padding:12px 16px;
            border-radius:30px;
            border:none;
            background:#1e293b;
            color:#fff;
            font-size:14px;
            outline:1px solid transparent;
        }
        #search:focus{outline-color:#6366f1}
        .groups{
            display:flex;
            gap:8px;
            overflow-x:auto;
            scrollbar-width:none;
            padding:4px 0;
        }
        .groups::-webkit-scrollbar{display:none}
        .group{
            padding:8px 16px;
            border-radius:30px;
            background:#1e293b;
            cursor:pointer;
            white-space:nowrap;
            font-size:14px;
            transition:0.2s;
        }
        .group.active{
            background:#6366f1;
        }
        .channels-holder{
            flex:1;
            overflow-y:auto;
            min-height:0;
        }
        .channels{
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
            gap:8px;
            padding:4px 0;
        }
        .channel{
            background:#1e293b;
            padding:8px;
            border-radius:12px;
            display:flex;
            align-items:center;
            gap:8px;
            cursor:pointer;
            transition:0.2s;
        }
        .channel:active{background:#7c3aed}
        .channel img{
            width:32px;
            height:32px;
            object-fit:contain;
            border-radius:6px;
            background:#0f172a;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <div class="logo">üì∫ LipkiTV</div>
    </div>

    <div class="video-wrap">
        <video id="video" controls playsinline></video>
    </div>

    <div id="now">üî¥ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</div>
    <input id="search" placeholder="üîç –ü–æ–∏—Å–∫..." type="text">
    <div class="groups" id="groups"></div>
    
    <div class="channels-holder">
        <div id="channels" class="channels"></div>
    </div>
</div>

<script>
    (function(){
        // === –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê ===
        const PLAYLIST_URL = "https://raw.githubusercontent.com/LinTV-OFFICAL/LinTV/refs/heads/main/LinIPTV.m3u";
        
        // === DOM —ç–ª–µ–º–µ–Ω—Ç—ã ===
        const video = document.getElementById('video');
        const groupsEl = document.getElementById('groups');
        const channelsEl = document.getElementById('channels');
        const searchInput = document.getElementById('search');
        const nowEl = document.getElementById('now');

        // === –°–æ—Å—Ç–æ—è–Ω–∏–µ ===
        let channels = [];
        let currentGroup = '';
        let hls = null;

        // === –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç ===
        async function loadPlaylist() {
            try {
                nowEl.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
                const res = await fetch(PLAYLIST_URL);
                const text = await res.text();
                parseM3U(text);
                nowEl.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ';
            } catch (e) {
                nowEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                console.error(e);
            }
        }

        // === –ü–∞—Ä—Å–∏–Ω–≥ M3U ===
        function parseM3U(text) {
            channels = [];
            const lines = text.split('\n');
            let meta = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF')) {
                    meta = line;
                } else if (line && !line.startsWith('#')) {
                    let name = line;
                    let group = '–î—Ä—É–≥–∏–µ';
                    let logo = '';

                    if (meta) {
                        const parts = meta.split(',');
                        if (parts.length > 1) name = parts.pop().trim();
                        
                        const g = meta.match(/group-title="([^"]+)"/i);
                        if (g) group = g[1];
                        
                        const l = meta.match(/tvg-logo="([^"]+)"/i);
                        if (l) logo = l[1];
                    }

                    channels.push({ name, url: line, group, logo });
                    meta = null;
                }
            }
            renderGroups();
        }

        // === –ì—Ä—É–ø–ø—ã ===
        function renderGroups() {
            const groups = [...new Set(channels.map(c => c.group))];
            groupsEl.innerHTML = groups.map(g => 
                `<div class="group${g === currentGroup ? ' active' : ''}" data-group="${g}">${g}</div>`
            ).join('');
            
            groupsEl.querySelectorAll('.group').forEach(el => {
                el.onclick = () => {
                    currentGroup = el.dataset.group;
                    groupsEl.querySelectorAll('.group').forEach(gr => gr.classList.remove('active'));
                    el.classList.add('active');
                    renderChannels();
                };
            });

            if (groups.length && !currentGroup) {
                currentGroup = groups[0];
                groupsEl.children[0]?.classList.add('active');
            }
            renderChannels();
        }

        // === –ö–∞–Ω–∞–ª—ã ===
        function renderChannels() {
            const query = searchInput.value.toLowerCase();
            const filtered = channels.filter(c => 
                c.group === currentGroup && c.name.toLowerCase().includes(query)
            );
            
            channelsEl.innerHTML = filtered.map(c => `
                <div class="channel" data-url="${c.url}" data-name="${c.name}" data-logo="${c.logo || ''}">
                    ${c.logo ? `<img src="${c.logo}" loading="lazy" onerror="this.style.display='none'">` : ''}
                    <div>${c.name}</div>
                </div>
            `).join('');

            channelsEl.querySelectorAll('.channel').forEach(el => {
                el.onclick = () => playChannel({
                    name: el.dataset.name,
                    url: el.dataset.url
                });
            });
        }

        // === –ü–æ–∏—Å–∫ ===
        searchInput.oninput = renderChannels;

        // === –ü–ª–µ–µ—Ä ===
        function playChannel(channel) {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            video.pause();
            video.removeAttribute('src');
            video.load();
            
            nowEl.textContent = `üîÑ ${channel.name}`;

            const tryPlay = (url, timeout = 8000) => {
                return new Promise((resolve, reject) => {
                    const timer = setTimeout(() => reject('timeout'), timeout);
                    
                    if (Hls.isSupported() && url.includes('.m3u8')) {
                        hls = new Hls({
                            maxBufferLength: 15,
                            xhrSetup: (xhr) => xhr.setRequestHeader('User-Agent', 
                                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0'
                            )
                        });
                        
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            clearTimeout(timer);
                            resolve();
                            if (video.paused) video.play().catch(() => {});
                        });
                        
                        hls.on(Hls.Events.ERROR, (_, data) => {
                            if (data.fatal) {
                                clearTimeout(timer);
                                reject('hls error');
                            }
                        });
                    } else {
                        video.src = url;
                        video.onloadeddata = () => {
                            clearTimeout(timer);
                            resolve();
                            if (video.paused) video.play().catch(() => {});
                        };
                        video.onerror = () => {
                            clearTimeout(timer);
                            reject('video error');
                        };
                    }
                });
            };

            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã URL
            const urls = [
                channel.url,
                channel.url.split('?')[0],
                channel.url + (channel.url.includes('?') ? '&' : '?') + '_t=' + Date.now()
            ];

            let attempt = 0;
            const tryNext = () => {
                if (attempt >= urls.length) {
                    nowEl.textContent = `‚ùå ${channel.name}`;
                    return;
                }
                
                tryPlay(urls[attempt++])
                    .then(() => nowEl.textContent = `‚ñ∂ ${channel.name}`)
                    .catch(tryNext);
            };
            
            tryNext();
        }

        loadPlaylist();
    })();
</script>
</body>
</html>
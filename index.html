<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LipkiTV - –£–º–Ω—ã–π –ø–ª–µ–µ—Ä</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
<script src="https://cdn.jsdelivr.net/npm/mux.js@6.0.0/dist/mux.min.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --accent:#6366f1;
  --accent2:#7c3aed;
  --text:#f1f5f9;
  --muted:#94a3b8;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Arial;
  height:100vh;
  display:flex;
}

.app{
  display:flex;
  flex-direction:column;
  width:100%;
  padding:12px;
  gap:12px;
}

.logo{
  text-align:center;
  font-size:26px;
  font-weight:bold;
  color:var(--accent);
}

.video-wrap{
  background:black;
  border-radius:16px;
  overflow:hidden;
  aspect-ratio:16/9;
  box-shadow:0 10px 25px rgba(0,0,0,0.5);
}

video{
  width:100%;
  height:100%;
}

#now{
  text-align:center;
  color:var(--muted);
  font-size:14px;
}

.groups{
  display:flex;
  gap:8px;
  overflow-x:auto;
  scrollbar-width:none;
}

.groups::-webkit-scrollbar{ display:none; }

.group{
  padding:8px 14px;
  border-radius:20px;
  background:var(--card);
  cursor:pointer;
  white-space:nowrap;
  font-size:14px;
  transition:0.2s;
}

.group.active{
  background:var(--accent);
}

#search{
  padding:10px;
  border-radius:8px;
  border:none;
  background:#0b1220;
  color:white;
  font-size:14px;
}

.channels-holder{
  flex:1;
  overflow-y:auto;
}

.channels{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:10px;
}

.channel{
  background:var(--card);
  padding:10px;
  border-radius:12px;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  transition:0.2s;
}

.channel:hover{
  background:var(--accent2);
}

.channel img{
  width:38px;
  height:38px;
  object-fit:contain;
  border-radius:6px;
  background:#0b1220;
}

@media(min-width:1600px){
  .channel{
    font-size:18px;
    padding:16px;
  }
}

.connection-status {
  font-size:12px;
  text-align:center;
  padding:4px;
  border-radius:4px;
  background:rgba(0,0,0,0.3);
}
</style>
</head>

<body>

<div class="app">

  <div class="logo">
    LipkiTV
    <span style="font-size:12px; background:#7c3aed; padding:2px 6px; border-radius:10px;">beta</span>
  </div>

  <div class="video-wrap">
    <video id="video" controls playsinline></video>
  </div>

  <div id="now">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</div>

  <div class="groups" id="groups"></div>

  <input id="search" placeholder="–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–∞..." type="text">

  <div class="channels-holder">
    <div id="channels" class="channels"></div>
  </div>

</div>

<script>
const PLAYLIST_URL = "https://raw.githubusercontent.com/smolnp/IPTVru/gh-pages/IPTVru.m3u";

const video = document.getElementById("video");
const groupsEl = document.getElementById("groups");
const channelsEl = document.getElementById("channels");
const searchInput = document.getElementById("search");
const nowEl = document.getElementById("now");

let channels = [];
let currentGroup = null;
let hls = null;
let currentRetryCount = 0;
const MAX_RETRIES = 3;

// –†–∞–∑–Ω—ã–µ User-Agent –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
const USER_AGENTS = [
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15',
  'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
  'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
];

async function loadPlaylist(){
  try{
    const response = await fetch(PLAYLIST_URL);
    const text = await response.text();
    parseM3U(text);
    nowEl.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª";
  }catch(e){
    nowEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞";
    console.error(e);
  }
}

function parseM3U(text){
  channels = [];
  const lines = text.split("\n");
  let meta = null;
  let userAgent = null;

  for(let i = 0; i < lines.length; i++){
    let line = lines[i].trim();

    if(line.startsWith("#EXTINF")){
      meta = line;
      
      const uaMatch = line.match(/ttp-user-agent="([^"]+)"/i);
      if(uaMatch) userAgent = uaMatch[1];
    }
    else if(line.startsWith("#EXTVLCOPT:")) {
      if(line.includes("http-user-agent=")) {
        userAgent = line.split("=").slice(1).join("=");
      }
    }
    else if(line && !line.startsWith("#")){
      let name = line;
      let group = "–î—Ä—É–≥–∏–µ";
      let logo = "";

      if(meta){
        const parts = meta.split(",");
        if(parts.length>1) name = parts.pop().trim();

        const g = meta.match(/group-title="([^"]+)"/i);
        if(g) group = g[1];

        const l = meta.match(/tvg-logo="([^"]+)"/i);
        if(l) logo = l[1];
      }

      channels.push({
        name, 
        url: line, 
        group, 
        logo,
        userAgent: userAgent || USER_AGENTS[0],
        baseUrl: line.split('/').slice(0, -1).join('/') // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
      });
      
      meta=null;
      userAgent=null;
    }
  }

  renderGroups();
}

function renderGroups(){
  const groups = [...new Set(channels.map(c=>c.group))];
  groupsEl.innerHTML="";

  groups.forEach(g=>{
    const el=document.createElement("div");
    el.className="group";
    el.textContent=g;
    el.onclick=()=>selectGroup(g);
    groupsEl.appendChild(el);
  });

  if(groups.length>0) selectGroup(groups[0]);
}

function selectGroup(g){
  currentGroup=g;
  [...groupsEl.children].forEach(el=>{
    el.classList.toggle("active",el.textContent===g);
  });
  renderChannels();
}

function renderChannels(){
  const q = searchInput.value.toLowerCase();
  channelsEl.innerHTML="";

  channels
    .filter(c=>c.group===currentGroup && c.name.toLowerCase().includes(q))
    .forEach(c=>{
      const el=document.createElement("div");
      el.className="channel";
      el.innerHTML = `
        ${c.logo ? `<img src="${c.logo}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'38\\' height=\\'38\\' viewBox=\\'0 0 24 24\\' fill=\\'%236366f1\\'%3E%3Cpath d=\\'M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM8 15v-4l4 2-4 2z\\'/%3E%3C/svg%3E';">` : ""}
        <div>${c.name}</div>
      `;
      el.onclick=()=>playWithRetry(c);
      channelsEl.appendChild(el);
    });
}

searchInput.oninput = renderChannels;

function playWithRetry(channel, retryCount = 0) {
  if (retryCount >= MAX_RETRIES) {
    nowEl.textContent = `‚ùå ${channel.name} - –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å`;
    return;
  }

  if (retryCount > 0) {
    nowEl.textContent = `üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}/${MAX_RETRIES}: ${channel.name}`;
  }

  // –ú–µ–Ω—è–µ–º User-Agent –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–µ
  const userAgent = retryCount < USER_AGENTS.length ? 
    USER_AGENTS[retryCount] : 
    USER_AGENTS[0];

  play(channel, userAgent, retryCount);
}

function play(channel, userAgent, retryCount) {
  if(hls) {
    hls.destroy();
    hls = null;
  }
  
  video.pause();
  video.removeAttribute('src');
  video.load();

  console.log(`Playing ${channel.name} with UA: ${userAgent}`);

  // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã URL
  const urlsToTry = [
    channel.url,
    // –ü—Ä–æ–±—É–µ–º –±–µ–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    channel.url.split('?')[0],
    // –ü—Ä–æ–±—É–µ–º —Å http –≤–º–µ—Å—Ç–æ https
    channel.url.replace('https://', 'http://'),
    // –ü—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫—ç—à–∞
    channel.url + (channel.url.includes('?') ? '&' : '?') + '_t=' + Date.now()
  ];

  tryPlayUrl(channel, urlsToTry, userAgent, retryCount, 0);
}

function tryPlayUrl(channel, urls, userAgent, retryCount, urlIndex) {
  if (urlIndex >= urls.length) {
    // –í—Å–µ URL –ø–µ—Ä–µ–ø—Ä–æ–±–æ–≤–∞–ª–∏
    playWithRetry(channel, retryCount + 1);
    return;
  }

  const currentUrl = urls[urlIndex];
  console.log(`Trying URL ${urlIndex + 1}/${urls.length}:`, currentUrl);

  // –î–ª—è m3u8 –ø–æ—Ç–æ–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º HLS.js
  if (Hls.isSupported() && currentUrl.includes('.m3u8')) {
    const config = {
      maxBufferLength: 30,
      maxMaxBufferLength: 60,
      enableWorker: true,
      liveSyncDurationCount: 3,
      fragLoadingTimeOut: 20000,
      manifestLoadingTimeOut: 20000,
      levelLoadingTimeOut: 20000,
      xhrSetup: (xhr, url) => {
        xhr.setRequestHeader('User-Agent', userAgent);
        xhr.setRequestHeader('Referer', 'https://www.google.com/');
        xhr.setRequestHeader('Origin', 'https://www.google.com');
        xhr.withCredentials = false;
      }
    };
    
    hls = new Hls(config);
    
    hls.loadSource(currentUrl);
    hls.attachMedia(video);
    
    let timeout = setTimeout(() => {
      // –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏
      if (hls) {
        hls.destroy();
        hls = null;
        tryPlayUrl(channel, urls, userAgent, retryCount, urlIndex + 1);
      }
    }, 15000);

    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      clearTimeout(timeout);
      nowEl.textContent = `‚ñ∂ ${channel.name}`;
      video.play()
        .catch(e => console.log('Auto-play prevented:', e));
    });

    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        console.error('HLS fatal error:', data);
        clearTimeout(timeout);
        hls.destroy();
        hls = null;
        tryPlayUrl(channel, urls, userAgent, retryCount, urlIndex + 1);
      }
    });

  } else {
    // –ü—Ä—è–º–æ–µ –≤–∏–¥–µ–æ
    video.src = currentUrl;
    
    let timeout = setTimeout(() => {
      video.removeAttribute('src');
      video.load();
      tryPlayUrl(channel, urls, userAgent, retryCount, urlIndex + 1);
    }, 10000);

    video.onloadeddata = () => {
      clearTimeout(timeout);
      nowEl.textContent = `‚ñ∂ ${channel.name}`;
      video.play().catch(e => console.log('Auto-play prevented:', e));
    };

    video.onerror = () => {
      clearTimeout(timeout);
      video.removeAttribute('src');
      video.load();
      tryPlayUrl(channel, urls, userAgent, retryCount, urlIndex + 1);
    };
  }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç
loadPlaylist();
</script>

</body>
</html>